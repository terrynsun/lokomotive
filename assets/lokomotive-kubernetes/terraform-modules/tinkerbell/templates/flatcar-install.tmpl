version: '0.1'
name: flatcar-install
global_timeout: 1800
tasks:
- name: "flatcar-install"
  worker: "{{.${machine}}}"
  volumes:
  - /dev:/dev
  - /statedir:/statedir
  actions:
  - name: "dump-ignition"
    image: flatcar-install
    command:
    - sh
    - -c
    - echo '${base64encode(ignition_config)}' | base64 -d > /statedir/ignition.json
  - name: "flatcar-install"
    image: flatcar-install # TODO docs: This image must be pushed to Tinkerbell registry.
    command:
    - /usr/local/bin/flatcar-install
    - -s # Experimentally use the smallest disk to install the OS.
    %{~ if os_version != "" ~}
    - -V
    - ${os_version}
    %{~ endif ~}
    %{~ if os_channel != "" ~}
    - -C
    - ${os_channel}
    %{~ endif ~}
    - -i
    - /statedir/ignition.json
    %{~ if flatcar_install_base_url != "" ~}
    - -b
    - ${flatcar_install_base_url}
    %{~ endif ~}
  - name: "reboot" # This task shouldn't really be there, but there is no other way to reboot the worker into target OS in Tinkerbell for now.
    image: alpine
    command:
    - sh
    - -c
    - 'echo 1 > /proc/sys/kernel/sysrq; echo b > /proc/sysrq-trigger'
